## 1. リリース目的
本ドキュメントは、本リリース（P0）の**合格ライン**と、実施手順・確認・ロールバックまでを**1枚に固定**し、仕様迷子と事故を防ぐ。

---

## 2. 対象範囲（P0 / P1 / P2）

### P0（本リリース対象）
- **event周りのみ**（一覧/詳細/作成/編集/更新/削除）
- eventのお気に入り（Favorite）
- event画像の追加/削除
- eventの認可（店舗オーナーのみ編集/更新/削除）
- 画像アップロード制限（形式/サイズ/枚数）
- メール送信（P0に含める）
  - 失敗時の仕様：**ユーザー体験は成功扱い**にしつつ、**ログ追跡できる状態**にする（P0-07）

### P1（次でOK）
- user/shop favorite
- 検索の最適化・パラメータ制限などの追加改善

### P2（後回し）
- 管理者ロール、通報、通知高度化、大規模UI改善など

---

## 3. 前提（現状）
- CI（テスト）が通ること
- セキュリティチェックが通ること（例：Brakeman / bundler-audit）
- デプロイ方式：Renderの **Git連携による自動デプロイ**

---

## 4. P0チェック（必須）

### 4.1 テスト（RSpec）
- [ ] `RAILS_ENV=test` でRSpecがgreen
- [ ] 重要仕様がspecで固定されている
  - [ ] P0-01：Event Favorite（ログイン必須＋作成/解除）
  - [ ] P0-02：Events 認可（店舗オーナーのみ編集/更新/削除）
  - [ ] P0-03：Event 画像削除（認可＋attachment増減）
  - [ ] P0-04：画像枚数制限（最大5枚）モデルspec

**実行例**
- `docker compose exec -e RAILS_ENV=test web bundle exec rspec`

### 4.2 画像（形式/サイズ/枚数）
許可・制限（P0固定）
- 許可形式：JPEG / PNG / WebP
- 最大サイズ：1枚あたり5MB以下
- 最大枚数：5枚まで

手動確認（必須）
- [ ] 正常：JPEG(<=5MB) を添付して作成/更新できる
- [ ] 異常（形式）：GIF/PDFを添付 → 保存されず、エラー表示（500にならない）
- [ ] 異常（サイズ）：6MB以上を添付 → 保存されず、エラー表示（500にならない）
- [ ] 異常（枚数）：6枚添付 → 保存されず、エラー表示（500にならない）

### 4.3 メール（Resend）
P0方針（固定）
- メール送信が失敗しても、**ユーザーの主要導線は成功扱い**（画面上は致命的に止めない）
- ただし、失敗は**必ず追跡可能**にする（ログ + Sentry）

手動確認（必須）
- [ ] 正常：想定メールが送信される（対象機能）
- [ ] 異常：メール送信失敗時に500にならない（少なくとも例外で落ちない）
- [ ] 失敗がログ or Sentryで追える

### 4.4 運用（監視/ログ/ヘルスチェック/バックアップ）

#### ヘルスチェック
- [ ] `GET /up` が **200** を返す

#### エラートラッキング（Sentry）
- 環境変数（Render Web Service に設定）
  - `SENTRY_DSN`
  - `SENTRY_ENVIRONMENT=production`
- 疎通確認（本番で1回だけ）
  - consoleで `Sentry.capture_message("prod sentry smoke test")`

#### Renderログの見方（最低限）
- Render管理画面 → Web Service → Logs
- よく見る検索キーワード例：
  - `Completed 500`
  - `ActiveRecord::` / `PG::`
  - `ActionController::`
  - `NoMethodError` / `ArgumentError`

#### DBバックアップ（最低限）
- 方針：障害対応・ロールバック前に、バックアップが取れる状態にする
- 手順：
  - RenderのPostgreSQL管理画面で取得可能なら、**手動バックアップ手順**を採用
  - 取得できない場合は、`DATABASE_URL` を用いた `pg_dump` の実行手順を別途用意（実行環境/権限に注意）

### 4.5 CI（必須）
- [ ] GitHub Actions が green（該当PR）
- [ ] main でも green

---

## 5. リリース手順（Render前提：Git連携自動デプロイ）

### 5.1 事前準備
- [ ] main が最新
- [ ] リリース対象PRが全てmerge済み
- [ ] RenderのEnvironment Variablesが設定済み
  - [ ] `SENTRY_DSN`
  - [ ] `SENTRY_ENVIRONMENT=production`
  - [ ] `RESEND_API_KEY`（利用している場合）
  - [ ] `DATABASE_URL`（Render側で設定済みであること）

### 5.2 デプロイ
- [ ] mainへマージ（= 自動デプロイ開始）
- [ ] RenderのDeployログでエラーがないことを確認
- [ ] Webが起動していること（アクセス可能、/upが200）

### 5.3 デプロイ直後の最低限チェック
- [ ] `/up` 200
- [ ] トップページ表示
- [ ] イベント一覧/詳細が表示できる
- [ ] ログインしてイベント作成ができる（最小）
- [ ] 画像添付ができる（最小）
- [ ] Favoriteができる（最小）

### 5.4 リリースリハ（P0-06：本番前に1回通す）
目的：リリース当日に事故らないよう、手順を一度“実際に回して”詰まりポイントを潰す。

#### リハ前チェック（必須）
- [ ] main が最新
- [ ] GitHub Actions が green（main / リリース対象PR）
- [ ] RSpec がローカルで green
  - `docker compose exec -e RAILS_ENV=test web bundle exec rspec`
- [ ] Render Web Service の環境変数が設定済み
  - [ ] `SENTRY_DSN`
  - [ ] `SENTRY_ENVIRONMENT=production`
  - [ ] `RESEND_API_KEY`（利用している場合）
  - [ ] `DATABASE_URL`（Render側で設定済みであること）
- [ ] /up が 200（本番）
- [ ] 画像アップロード制限（形式/サイズ/枚数）仕様が固定されている

#### リハ手順（実施）
1. Render管理画面 → Web Service → Deploys / Logs を開く
2. mainにマージ（もしくは最新mainをデプロイ）して自動デプロイを走らせる
3. Deployログでエラーがないことを確認
4. 本番で /up が 200 を返すことを確認
5. 主要導線チェック（6章）を上から順に実施
6. Sentry疎通（本番で1回だけ）
   - consoleで `Sentry.capture_message("prod sentry smoke test")` を実行し、Sentryに届くこと
7. 異常があれば即記録
   - P0/P1/P2 に分類してIssue化（P0はその場で潰す）

#### リハの合格条件
- [ ] /up が 200
- [ ] 主要導線チェックが全てOK
- [ ] 500が継続発生していない（Render Logs / Sentryで確認）
- [ ] ロールバック手順が“実際に実行可能な手順”になっている

---

## 6. リリース後確認（主要導線チェック）

### 未ログイン
- [ ] イベント一覧が見れる
- [ ] イベント詳細が見れる
- [ ] お気に入り（Favorite）実行でログインへ誘導される

### ログイン済み（店舗オーナー）
- [ ] イベント作成
- [ ] イベント編集/更新
- [ ] 画像の追加
- [ ] 画像の削除（削除後に枚数が減る）
- [ ] 削除（destroy）ができる

### ログイン済み（他人＝店舗オーナー以外）
- [ ] edit/update/destroy が弾かれる（仕様通り：リダイレクト等）
- [ ] DBが変更されない

---

## 7. ロールバック手順（事故ったらこれ）

### 7.1 ロールバック判断基準（P0）
- 主要導線が壊れている（一覧/詳細/作成/編集/更新/削除/favorite/画像）
- 500が継続的に発生
- データ破壊の可能性がある

### 7.2 手順（Render：Git連携前提）
1. Render管理画面 → Web Service → Deploys を開く
2. **直前の安定していたデプロイ**を特定する（Deployの時刻とコミットを確認）
3. 可能なら「前のデプロイを再デプロイ（Redeploy）」して戻す  
   - UIで戻せない/不安な場合：Gitで安定コミットへ `revert` を作成 → mainへマージ → 自動デプロイ
4. ロールバック後に確認
   - [ ] `/up` 200
   - [ ] 主要導線（6章）の最低限を再確認
5. 障害の原因追跡
   - Render Logs
   - Sentry（イベント/例外）

---

## 8. 仕様固定メモ（P0でブレさせない）
- P0は **event周りのみ**
- user/shop favorite は P1
- メールはP0に含めるが、失敗時は「ユーザー体験は成功扱い + 追跡は必須」
- 迷ったら「本番で事故らない・直しやすい」を優先する