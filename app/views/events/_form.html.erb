<% if event.errors.any? %>
  <div class="mb-4 rounded-md bg-red-50 border border-red-200 p-4 text-sm text-red-700">
    <p class="font-semibold mb-1">入力内容にエラーがあります。</p>
    <ul class="list-disc list-inside">
      <% event.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if event.shop.present? %>
  <p class="text-center text-slate-500 mb-8">
    主催者：<strong><%= event.shop.user.name %></strong>
  </p>
<% end %>

<%= form_with model: event, local: true do |f| %>
  <div class="space-y-4">

    <div>
      <%= f.label :title, "イベントタイトル", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.text_field :title,
            placeholder: "例：初心者歓迎ハウストーナメント",
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div>
      <%= f.label :start_datetime, "開始日時", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.datetime_field :start_datetime,
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div>
      <%= f.label :end_datetime, "終了日時（任意）", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.datetime_field :end_datetime,
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div>
      <%= f.label :shop_id, "開催場所（店舗）", class: "block text-sm font-medium text-slate-700 mb-1" %>

      <%= f.select :shop_id,
            options_from_collection_for_select(@owned_shops, :id, :name, event.shop_id),
            { include_blank: "選択してください" },
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm
                    focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>

      <p class="mt-1 text-xs text-slate-500">
        ※ 登録している店舗から選択できます
      </p>
    </div>

    <div>
      <%= f.label :address, "住所（任意）", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.text_field :address,
            placeholder: "宮崎市●●丁目…",
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <%= f.label :prefecture, "都道府県", class: "block text-sm font-medium text-slate-700 mb-1" %>
        <%= f.text_field :prefecture,
              placeholder: "宮崎県",
              class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                    focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
      </div>
      <div>
        <%= f.label :city, "市区町村", class: "block text-sm font-medium text-slate-700 mb-1" %>
        <%= f.text_field :city,
              placeholder: "宮崎市✕✕",
              class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                      focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
      </div>
    </div>

    <div>
      <%= f.label :fee, "参加費（円）", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.number_field :fee,
            min: 0,
            placeholder: "例）1000",
            class: "block w-full max-w-[200px] rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div>
      <%= f.label :capacity, "定員（任意）", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.number_field :capacity,
            min: 1,
            placeholder: "例）32",
            class: "block w-full max-w-[200px] rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div>
      <%= f.label :entry_deadline, "申し込み締切（任意）", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.datetime_field :entry_deadline,
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div data-controller="pro-picker"
        data-pro-picker-url-value="<%= pro_suggestions_users_path %>">

      <label class="block text-sm font-medium mb-2">参加予定プロ</label>
      <div class="flex flex-wrap gap-2 mb-2" data-pro-picker-target="selected">
        <input type="hidden" name="event[pro_player_ids][]" value="">
        <% (event.pro_players || []).each do |u| %>
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white"
                data-user-id="<%= u.id %>">
            <span><%= u.name %></span>
            <button type="button"
                    class="text-slate-500 hover:text-red-600"
                    data-action="click->pro-picker#remove"
                    data-user-id="<%= u.id %>">×</button>
            <input type="hidden" name="event[pro_player_ids][]" value="<%= u.id %>">
          </span>
        <% end %>
      </div>

      <input type="text"
            class="w-full border rounded-md px-3 py-2"
            placeholder="プロ名で検索"
            data-pro-picker-target="input"
            data-action="input->pro-picker#search keydown->pro-picker#preventEnter">

      <div class="mt-2" data-pro-picker-target="results"></div>
    </div>

    <div>
      <%= f.label :description, "イベント詳細", class: "block text-sm font-medium text-slate-700 mb-1" %>
      <%= f.text_area :description,
            rows: 6,
            class: "block w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm 
                  focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" %>
    </div>

    <div class="space-y-1">
      <%= f.label :images, "イベント画像（複数枚OK）", class: "block text-sm font-medium text-slate-700" %>
      <%= f.file_field :images,
            multiple: true,
            accept: "image/*",
            class: "block w-full text-sm text-slate-700" %>

      <% if event.persisted? && event.images.attached? %>
        <p class="text-xs text-slate-500 mt-1">登録済みの画像：</p>
        <div class="mt-2 flex flex-wrap gap-2">
          <% event.images.each do |image| %>
            <% next unless image.persisted? %>
            <div class="relative group">
              <%= image_tag image.variant(resize_to_fill: [160, 100]),
                    class: "h-24 w-40 rounded object-cover border" %>

              <%= link_to "×",
                    image_event_path(event, image_id: image.id),
                    data: {
                      turbo_method: :delete,
                      turbo_confirm: "この画像を削除しますか？"
                    },
                    class: "absolute -top-2 -right-2 h-6 w-6 rounded-full bg-black text-white text-xs font-bold flex items-center justify-center opacity-0 group-hover:opacity-100 transition" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="pt-2">
      <%= f.submit event.persisted? ? "イベントを更新する" : "イベントを公開する",
            class: "w-full inline-flex justify-center items-center rounded-md bg-black 
                  px-4 py-2 text-sm font-semibold text-white shadow-sm 
                  hover:bg-slate-800 focus:outline-none focus:ring-2 
                  focus:ring-slate-500 focus:ring-offset-2" %>
    </div>
  </div>
<% end %>